# az-sk Scanner

- [az-sk Scanner](#az-sk-scanner)
  - [Implementation details](#implementation-details)
  - [Configuration](#configuration)
  - [Az-sk wrapper script](#az-sk-wrapper-script)
  - [Az-sk results aggregator](#az-sk-results-aggregator)
  - [Blob Storage service](#blob-storage-service)
    - [Azure Blob Storage](#azure-blob-storage)
    - [Audit result format](#audit-result-format)
    - [Scanner metadata](#scanner-metadata)
  - [Runtime](#runtime)

The scanner wraps [Secure DevOps Kit for Azure by Microsoft](https://azsk.azurewebsites.net/index.html) - Azure subscription security validator.

The scanner itself does not add anything new to the original az-sk tool. You can consider it only as an az-sk audit data shipper:

- invoke az-sk with provided configuration;
- upload results to a **Blob Storage** service.

## Implementation details

The scanner is a cli tool written in `dotnet core 3`. It expects `az-sk` powershell module to be installed to the same working environment.

The application invokes `az-sk` as external process and uploads generated by it files to Blob Storage. Powershell parameters and Blob Storage credentials are provided by Scanner configuration file.

***NOTE:*** The scanner requires *a read permission to the entire Azure subscription*. Therefore, Service Principal, which represents the scanner application in desired Azure Active Directory should have `Reader` role in scope of each desired subscription. To create such entity, you can use `az cli` command:

```sh
az ad sp create-for-rbac -n "azsk-scanner" --role Reader --scopes /subscriptions/SUBSCRIPTION_ID_1 /subscriptions/SUBSCRIPTION_ID_2
```

## Configuration

The scanner configuration consists of two parts:

- yaml configuration file with most of parameters: scanner identifier and schedule, blob storage credentials, etc.
- list of subscription identifiers provided as a cli option.

Likely, several Azure Subscriptions could be scanned based on the same config, but only identifier of the subscription would be different. Thus, subscription id is moved out of config file.

## Az-sk wrapper script

`az-sk` consist of several PowerShell commands, that can be used in conjunction to cover more security aspects of the Azure cloud. At the same time, az-sk expects current user-session to be logged into Azure. To simplify scanner code, the subset of az-sk commands are wrapped into a single PS-script, which:

- Imports az-sk PS module int ocurrent user-session;
- connects to azure (`Connect-AzAccount`);
- sets `az-sk` output folder (`Set-AzSKUserPreference`);
- _aggrees_ with `az-sk` end-user license agreement (`Set-AzSKPrivacyNoticeResponse`);
- runs security checks (`Get-AzSKSubscriptionSecurityStatus` and `Get-AzSKAzureServicesSecurityStatus`).

## Az-sk results aggregator

Each az-sk security check produces multiple log files and several scan-result summaries. `joseki` is focused only on a single folder: `./AzSKLogs/{SUBSCRIPTOIN_NAME}/{CHECK_DATE_TIME}_{CHECK_TYPE}/Etc`. The folder contains multiple log files and detailed scan result encoded into json. The scanner agreggates all log files into a single one and uploads it to Blob Storage along with json scan-result.

As az-sk wrapper does two security checks (subscription-based and services-based), the scanner uploads four files per each subscription audit.

## Blob Storage service

At the moment only Azure Blob Storage is supported.

### Azure Blob Storage

To access the service the scanners uses official [Microsoft Storage Blob](https://www.nuget.org/packages/Microsoft.Azure.Storage.Blob/) Nuget library

Permission to write data to exact folder is given with [Shared Access Signature](https://docs.microsoft.com/en-us/azure/storage/common/storage-sas-overview). To generate a SAS token the following `az cli` could be used:

```sh
az storage container generate-sas --name CONTAINER_NAME --account-key STORAGE_ACCOUNT_KEY --account-name STORAGE_ACCOUNT_NAME --expiry 2020-02-01 --permissions rw
```

### Audit result format

Uploaded audit results should follow the general [technical design doc](/TECH_DESIGN.md#backend-and-scanners), where

- `scanner-type` is `az-sk`;
- `scanner-id` and `scanner-periodicity` are taken from scanner config

Each audit result folder should have two files:

- `meta` - json object, which describes audit metadata:
  - `audit-id`
  - `scanner-version`
  - `timestamp` - unix epoch in seconds;
  - `audit-result` - `succeeded`, `audit-failed`, `upload-failed`;
  - `failure-description` - (optional) if `audit-result` is failed, explains the reason;
  - `az-sk-version`
  - `az-sk-audit-paths` - path to all files with audit results
- `*.json` - `az-sk` audit results.

Each file upload is retried 3 times with exponential backoff. If still failing - `meta` file has human-readable explanation in `failure-description` property.

### Scanner metadata

After each audit iteration is completed, the scanner should update general metadata file at `/az-sk-{scanner-id-short-hash}/az-sk-{scanner-id-short-hash}.meta` with schema:

```json
{
  "scanner-type": "az-sk",
  "scanner-id": "{UUID}",
  "scanner-periodicity": "{cron-expression}",
  "heartbeat-periodicity": "int",
  "heartbeat": 1579619671
}
```

Where `heartbeat-periodicity` is scanner-periodicity in seconds.

## Runtime

The scanner is running in a docker container. Thus all the dependencies should be istalled into it:

- [powershell-core](https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell-core-on-linux?view=powershell-7);
- [azsk powershell module](https://www.powershellgallery.com/packages/AzSK/4.5.1);
- scanner code and `az-sk` wrapper script.
